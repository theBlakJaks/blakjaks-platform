default_platform(:ios)

APP_IDENTIFIER = "com.blakjaks.app"
SCHEME         = "BlakJaks"
PROJECT        = "BlakJaks.xcodeproj"

platform :ios do

  # ── beta: build archive → upload to TestFlight ─────────────────────────────
  lane :beta do
    api_key = app_store_connect_api_key(
      key_id:        ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id:     ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
      key_content:   ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
      is_key_content_base64: true
    )

    # Bump build number to current UTC timestamp so every CI run is unique
    increment_build_number(
      build_number: Time.now.utc.strftime("%Y%m%d%H%M"),
      xcodeproj: PROJECT
    )

    # Set marketing version from tag (e.g. v1.2.3 → 1.2.3)
    if ENV["MARKETING_VERSION"]
      increment_version_number(
        version_number: ENV["MARKETING_VERSION"],
        xcodeproj: PROJECT
      )
    end

    build_app(
      scheme:               SCHEME,
      project:              PROJECT,
      configuration:        "Release",
      export_method:        "app-store",
      output_directory:     "./build",
      output_name:          "BlakJaks.ipa",
      clean:                true,
      include_bitcode:      false,
      export_xcargs:        "-allowProvisioningUpdates"
    )

    upload_to_testflight(
      api_key:                     api_key,
      app_identifier:              APP_IDENTIFIER,
      ipa:                         "./build/BlakJaks.ipa",
      skip_waiting_for_build_processing: true,
      changelog:                   "Build #{ENV['GITHUB_SHA']&.slice(0, 7)} — automated CI release"
    )
  end

  # ── tests: run unit test suite locally (mirrors CI xcodebuild call) ─────────
  lane :tests do
    run_tests(
      scheme:      SCHEME,
      project:     PROJECT,
      destination: "platform=iOS Simulator,name=iPhone 16 Pro,OS=latest",
      clean:       true,
      code_coverage: true
    )
  end

end
