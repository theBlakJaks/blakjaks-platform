name: Build & Deploy

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main]

permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: blakjaks-production
  REGION: us-central1
  CLUSTER: blakjaks-primary
  REGISTRY: us-central1-docker.pkg.dev/blakjaks-production/blakjaks-repo

jobs:

  # ── Detect which directories changed ───────────────────────────────────────
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend:   ${{ steps.filter.outputs.backend }}
      web-app:   ${{ steps.filter.outputs.web-app }}
      affiliate: ${{ steps.filter.outputs.affiliate }}
      admin:     ${{ steps.filter.outputs.admin }}
      wholesale: ${{ steps.filter.outputs.wholesale }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            web-app:
              - 'web-app/**'
            affiliate:
              - 'affiliate/**'
            admin:
              - 'admin/**'
            wholesale:
              - 'wholesale/**'

  # ── Backend: build image + run tests ───────────────────────────────────────
  test:
    needs: [changes]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install backend dependencies
        run: pip install -e "backend/[dev]"

      - name: Run backend tests
        run: pytest backend/tests/ -v --tb=short
        env:
          DATABASE_URL: sqlite+aiosqlite:///./test.db
          SECRET_KEY: test-secret-key-ci
          ENVIRONMENT: test

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/752012521116/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: blakjaks-service-account@blakjaks-production.iam.gserviceaccount.com

      - name: Set up Docker auth
        uses: google-github-actions/setup-gcloud@v2

      - run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: Build & push backend image
        run: |
          docker build -t $REGISTRY/backend:$GITHUB_SHA ./backend
          docker push $REGISTRY/backend:$GITHUB_SHA

  # ── Production: API + Celery worker + Celery beat ──────────────────────────
  deploy-api:
    needs: [changes, test]
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/752012521116/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: blakjaks-service-account@blakjaks-production.iam.gserviceaccount.com

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.CLUSTER }}
          location: ${{ env.REGION }}

      - name: Deploy API + Celery to production
        run: |
          kubectl set image deployment/backend       backend=$REGISTRY/backend:$GITHUB_SHA       -n production || echo "::warning::production/backend not found – skipping (namespace not yet bootstrapped)"
          kubectl set image deployment/celery-worker celery-worker=$REGISTRY/backend:$GITHUB_SHA -n production || true
          kubectl set image deployment/celery-beat   celery-beat=$REGISTRY/backend:$GITHUB_SHA   -n production || true
          kubectl rollout status deployment/backend       -n production --timeout=300s || true
          kubectl rollout status deployment/celery-worker -n production --timeout=300s || true
          kubectl rollout status deployment/celery-beat   -n production --timeout=300s || true

  # ── Production: web-app ─────────────────────────────────────────────────────
  deploy-web-app:
    needs: [changes, test]
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      needs.changes.outputs.web-app == 'true'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/752012521116/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: blakjaks-service-account@blakjaks-production.iam.gserviceaccount.com

      - name: Set up Docker auth
        uses: google-github-actions/setup-gcloud@v2

      - run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: Build & push web-app image
        run: |
          docker build -t $REGISTRY/web-app:$GITHUB_SHA ./web-app
          docker push $REGISTRY/web-app:$GITHUB_SHA

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.CLUSTER }}
          location: ${{ env.REGION }}

      - name: Deploy web-app to production
        run: |
          kubectl set image deployment/web-app web-app=$REGISTRY/web-app:$GITHUB_SHA -n production || echo "::warning::production/web-app not found – skipping"
          kubectl rollout status deployment/web-app -n production --timeout=300s || true

  # ── Production: affiliate portal ────────────────────────────────────────────
  deploy-affiliate:
    needs: [changes, test]
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      needs.changes.outputs.affiliate == 'true'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/752012521116/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: blakjaks-service-account@blakjaks-production.iam.gserviceaccount.com

      - name: Set up Docker auth
        uses: google-github-actions/setup-gcloud@v2

      - run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: Build & push affiliate image
        run: |
          docker build -t $REGISTRY/affiliate:$GITHUB_SHA ./affiliate
          docker push $REGISTRY/affiliate:$GITHUB_SHA

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.CLUSTER }}
          location: ${{ env.REGION }}

      - name: Deploy affiliate to production
        run: |
          kubectl set image deployment/affiliate affiliate=$REGISTRY/affiliate:$GITHUB_SHA -n production || echo "::warning::production/affiliate not found – skipping"
          kubectl rollout status deployment/affiliate -n production --timeout=300s || true

  # ── Production: admin dashboard ─────────────────────────────────────────────
  deploy-admin:
    needs: [changes, test]
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      needs.changes.outputs.admin == 'true'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/752012521116/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: blakjaks-service-account@blakjaks-production.iam.gserviceaccount.com

      - name: Set up Docker auth
        uses: google-github-actions/setup-gcloud@v2

      - run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: Build & push admin image
        run: |
          docker build -t $REGISTRY/admin:$GITHUB_SHA ./admin
          docker push $REGISTRY/admin:$GITHUB_SHA

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.CLUSTER }}
          location: ${{ env.REGION }}

      - name: Deploy admin to production
        run: |
          kubectl set image deployment/admin admin=$REGISTRY/admin:$GITHUB_SHA -n production || echo "::warning::production/admin not found – skipping"
          kubectl rollout status deployment/admin -n production --timeout=300s || true

  # ── Production: wholesale portal ─────────────────────────────────────────────
  deploy-wholesale:
    needs: [changes, test]
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      needs.changes.outputs.wholesale == 'true'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/752012521116/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: blakjaks-service-account@blakjaks-production.iam.gserviceaccount.com

      - name: Set up Docker auth
        uses: google-github-actions/setup-gcloud@v2

      - run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: Build & push wholesale image
        run: |
          docker build -t $REGISTRY/wholesale:$GITHUB_SHA ./wholesale
          docker push $REGISTRY/wholesale:$GITHUB_SHA

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.CLUSTER }}
          location: ${{ env.REGION }}

      - name: Deploy wholesale to production
        run: |
          kubectl set image deployment/wholesale wholesale=$REGISTRY/wholesale:$GITHUB_SHA -n production || echo "::warning::production/wholesale not found – skipping"
          kubectl rollout status deployment/wholesale -n production --timeout=300s || true

  # ── Staging: full-stack deploy on push to staging branch ───────────────────
  deploy-staging:
    needs: [test]
    if: github.ref == 'refs/heads/staging' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: staging
    env:
      STAGING_REGISTRY: us-central1-docker.pkg.dev/blakjaks-production/blakjaks-repo
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/752012521116/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: blakjaks-service-account@blakjaks-production.iam.gserviceaccount.com

      - name: Set up Docker auth
        uses: google-github-actions/setup-gcloud@v2

      - run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: Build staging images
        run: |
          docker build -t $STAGING_REGISTRY/backend:staging-$GITHUB_SHA   ./backend
          docker build -t $STAGING_REGISTRY/web-app:staging-$GITHUB_SHA   ./web-app
          docker build -t $STAGING_REGISTRY/affiliate:staging-$GITHUB_SHA ./affiliate
          docker build -t $STAGING_REGISTRY/admin:staging-$GITHUB_SHA     ./admin
          docker build -t $STAGING_REGISTRY/wholesale:staging-$GITHUB_SHA ./wholesale
          docker push $STAGING_REGISTRY/backend:staging-$GITHUB_SHA
          docker push $STAGING_REGISTRY/web-app:staging-$GITHUB_SHA
          docker push $STAGING_REGISTRY/affiliate:staging-$GITHUB_SHA
          docker push $STAGING_REGISTRY/admin:staging-$GITHUB_SHA
          docker push $STAGING_REGISTRY/wholesale:staging-$GITHUB_SHA

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.CLUSTER }}
          location: ${{ env.REGION }}

      - name: Deploy all services to staging namespace
        env:
          BLOCKCHAIN_POLYGON_NETWORK: mumbai
          TELLER_ENV: sandbox
          TAG: staging-${{ github.sha }}
        run: |
          # Backend API
          kubectl set image deployment/backend       backend=$STAGING_REGISTRY/backend:$TAG       -n staging
          kubectl set image deployment/celery-worker celery-worker=$STAGING_REGISTRY/backend:$TAG -n staging
          kubectl set image deployment/celery-beat   celery-beat=$STAGING_REGISTRY/backend:$TAG   -n staging
          # Frontends
          kubectl set image deployment/web-app   web-app=$STAGING_REGISTRY/web-app:$TAG     -n staging
          kubectl set image deployment/affiliate affiliate=$STAGING_REGISTRY/affiliate:$TAG  -n staging
          kubectl set image deployment/admin     admin=$STAGING_REGISTRY/admin:$TAG          -n staging
          kubectl set image deployment/wholesale wholesale=$STAGING_REGISTRY/wholesale:$TAG  -n staging
          # Patch staging-specific env vars onto API deployment
          kubectl set env deployment/backend \
            BLOCKCHAIN_POLYGON_NETWORK=$BLOCKCHAIN_POLYGON_NETWORK \
            TELLER_ENV=$TELLER_ENV \
            -n staging
          # Wait for rollouts
          kubectl rollout status deployment/backend       -n staging --timeout=300s
          kubectl rollout status deployment/celery-worker -n staging --timeout=300s
          kubectl rollout status deployment/celery-beat   -n staging --timeout=300s
          kubectl rollout status deployment/web-app       -n staging --timeout=300s

  # ── Staging smoke test: runs after deploy, before load tests ────────────────
  smoke-test:
    name: Staging Smoke Test
    needs: [deploy-staging]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install httpx rich

      - name: Wait for staging to be healthy
        run: |
          echo "Waiting for staging API…"
          for i in {1..12}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.STAGING_API_URL }}/health" || echo "000")
            if [ "$STATUS" = "200" ]; then echo "Healthy after ${i}×10s"; break; fi
            echo "  Attempt $i/12 — HTTP $STATUS — waiting 10s…"
            sleep 10
          done

      - name: Run smoke test
        env:
          STAGING_API_URL: ${{ secrets.STAGING_API_URL }}
          SMOKE_TEST_EMAIL: ${{ secrets.LOAD_TEST_EMAIL }}
          SMOKE_TEST_PASSWORD: ${{ secrets.LOAD_TEST_PASSWORD }}
          SMOKE_ADMIN_EMAIL: ${{ secrets.SMOKE_ADMIN_EMAIL }}
          SMOKE_ADMIN_PASSWORD: ${{ secrets.SMOKE_ADMIN_PASSWORD }}
          SMOKE_TEST_QR_CODE: ${{ secrets.LOAD_TEST_QR_CODE }}
        run: python scripts/staging_smoke_test.py --stop-on-fail

  # ── Load tests: run against staging after deploy ────────────────────────────
  load-test:
    name: Load Test (Staging)
    needs: [deploy-staging, smoke-test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring \
            --keyring /usr/share/keyrings/k6-archive-keyring.gpg \
            --keyserver hkp://keyserver.ubuntu.com:80 \
            --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" \
            | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update && sudo apt-get install k6 -y

      - name: Wait for staging to be healthy
        run: |
          echo "Waiting for staging API to become healthy…"
          for i in {1..12}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.STAGING_API_URL }}/health" || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "Staging healthy after ${i}x10s"
              break
            fi
            echo "  Attempt $i/12 — status $STATUS — waiting 10s…"
            sleep 10
          done

      - name: Create results directory
        run: mkdir -p results

      - name: Run scan burst test
        run: |
          k6 run \
            -e K6_BASE_URL=${{ secrets.STAGING_API_URL }} \
            -e K6_TEST_EMAIL=${{ secrets.LOAD_TEST_EMAIL }} \
            -e K6_TEST_PASSWORD=${{ secrets.LOAD_TEST_PASSWORD }} \
            -e K6_TEST_QR_CODE=${{ secrets.LOAD_TEST_QR_CODE }} \
            --out json=results/scan_burst.json \
            load-tests/scan_burst.js

      - name: Run withdrawal safety test
        run: |
          k6 run \
            -e K6_BASE_URL=${{ secrets.STAGING_API_URL }} \
            -e K6_TEST_EMAIL=${{ secrets.LOAD_TEST_EMAIL }} \
            -e K6_TEST_PASSWORD=${{ secrets.LOAD_TEST_PASSWORD }} \
            -e K6_TEST_COMP_ID=${{ secrets.LOAD_TEST_COMP_ID }} \
            --out json=results/withdrawal_safety.json \
            load-tests/withdrawal_safety.js

      - name: Upload k6 results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: k6-results-${{ github.sha }}
          path: results/
          retention-days: 30
